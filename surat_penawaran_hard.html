<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Surat Penawaran Resmi - Lidan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Times+New+Roman&display=swap');
        
        body { background-color: #f3f4f6; font-family: 'Times New Roman', Times, serif; }
        
        /* Format Kertas A4 */
        .paper {
            width: 210mm;
            min-height: 297mm;
            /* Padding atas dikurangi menjadi 10mm agar kop rapat ke atas */
            padding: 10mm 25mm 25mm 25mm; 
            margin: 20px auto;
            background: white;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            position: relative;
        }

        .line-header { border-bottom: 3px solid #BF1A54; margin-top: 5px; }
        .line-header-thin { border-bottom: 1px solid #BF1A54; margin-top: 2px; }

        @media print {
            body { background: none; padding: 0; }
            .paper { margin: 0; box-shadow: none; width: 100%; }
            .no-print { display: none; }
        }

        .content-text { line-height: 1.6; text-align: justify; font-size: 12pt; }
        .qr-area { width: 120px; height: 120px; }
    </style>
</head>
<body>

    <div class="no-print fixed top-5 right-5 flex gap-2">
        <button onclick="window.print()" class="bg-gray-600 text-white px-6 py-2 rounded-full font-bold shadow-lg hover:bg-gray-700 transition">Cetak / Print</button>
        <button onclick="downloadPDF()" class="bg-indigo-600 text-white px-6 py-2 rounded-full font-bold shadow-lg hover:bg-indigo-700 transition">Download PDF (A4)</button>
    </div>

    <div class="paper" id="invoice-content">
        
        <div class="flex items-center gap-4 mb-0">
            <img src="https://lidan.co.id/gambar/logo-baru.png" alt="Logo Lidan" class="w-24 h-auto object-contain">
            <div class="flex-1 text-center">
                <h1 style="color: #BF1A54;" class="text-3xl font-bold uppercase tracking-widest">
  PT Lidan Indah Abadi
</h1>
                <p class="text-sm">Jl. Imam Bonjol No. 9, Regus Forum Nine Lt.9 , Medan, Sumatera Utara</p>
                <p class="text-sm italic text-gray-600">Email: info@lidan.co.id | Website: lidan.co.id| Whatsapp: 0851 5960 1400</p>
            </div>
        </div>
        
        <div class="line-header" style="background-color: #BF1A54; height: 3px; margin-top: 10px;"></div>
<div class="line-header-thin" style="background-color: #BF1A54; height: 1px; margin-top: 2px;"></div>

        <div id="loading" class="text-center py-20">
            <p class="animate-pulse font-bold text-gray-400">Menyusun Dokumen...</p>
        </div>

        <div id="surat-isi" class="hidden mt-4">
            <div class="flex justify-between mb-8">
                <div class="space-y-1">
                    <table>
                        <tr><td class="w-24">Nomor</td><td>: <span id="nomor" class="font-bold"></span></td></tr>
                        <tr><td>Lampiran</td><td>: <span id="lampiran"></span></td></tr>
                        <tr><td>Perihal</td><td>: <span id="perihal" class="font-bold underline"></span></td></tr>
                    </table>
                </div>
                <div id="tanggal" class="text-right"></div>
            </div>

            <div class="mb-10">
                <p>Kepada Yth,</p>
                <p id="penerima" class="font-bold uppercase mt-1"></p>
                <p id="instansi" class="font-bold"></p>
                <p>Di Tempat</p>
            </div>

            <div class="content-text space-y-4">
                <p>Dengan hormat,</p>
                
                <p>
                    Sehubungan dengan adanya kebutuhan pengembangan sumber daya manusia dan peningkatan efektivitas kerja, 
                    kami dari <strong>PT Lidan Indah Abadi</strong> bermaksud mengajukan penawaran kerjasama terkait 
                    <span id="perihal-body" class="italic"></span>.
                </p>

                <div id="keterangan" class="bg-gray-50 p-4 rounded-lg border italic text-gray-700">
                    </div>

                <p>
                    Besar harapan kami agar penawaran ini dapat memberikan kontribusi positif bagi instansi Bapak/Ibu. 
                    Detail teknis dan biaya terkait penawaran ini kami lampirkan bersama dengan surat ini.
                </p>

                <p>Demikian surat penawaran ini kami sampaikan. Atas perhatian dan kerjasama Bapak/Ibu, kami ucapkan terima kasih.</p>
            </div>

            <div class="mt-16 flex justify-end">
                <div class="text-center">
                    <p>Hormat kami,</p>
                    <p class="font-bold">PT Lidan Indah Abadi</p>
                    
                    <div class="flex justify-center my-4">
                        <div id="qrcode" class="qr-area p-2 border border-gray-100 shadow-sm"></div>
                    </div>

                    <p id="nama-penanda" class="font-bold underline uppercase"></p>
                    <p id="jabatan-penanda" class="text-sm italic"></p>
                    <p class="text-[8pt] text-gray-400 mt-2">Verified Digital Signature</p>
                </div>
            </div>

            <div class="absolute bottom-10 left-10 right-10 flex justify-between items-end border-t pt-2 text-[9pt] text-gray-400 italic">
                <p>Surat ini sah dan diterbitkan secara elektronik melalui sistem verifikasi Lidan.</p>
                <p id="token-footer"></p>
            </div>
        </div>

    </div>

    <script>
        const API_URL = 'https://lidan-co-id.pages.dev/api/contacts_filter_dinamis6';
        const TABLE_TARGET = 'surat_penawaran';
        const AUTH_KEY = 'admin';

        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        async function fetchSurat() {
            if(!token) {
                document.getElementById('loading').innerHTML = "<span class='text-red-500'>Error: Token Tidak Ditemukan.</span>";
                return;
            }

            try {
                const res = await fetch(`${API_URL}?table=${TABLE_TARGET}&x_10_eq=${token}`, {
                    headers: { 'X-Custom-Auth': AUTH_KEY }
                });
                const result = await res.json();

                if(result.success && result.data.length > 0) {
                    renderSurat(result.data[0]);
                } else {
                    document.getElementById('loading').innerHTML = "<span class='text-red-500'>Error: Data Surat Tidak Valid.</span>";
                }
            } catch (e) {
                console.error(e);
            }
        }

        function renderSurat(data) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('surat-isi').classList.remove('hidden');

            document.getElementById('nomor').innerText = data.x_05 || '-';
            document.getElementById('lampiran').innerText = data.x_08 || '-';
            document.getElementById('perihal').innerText = data.x_06 || '-';
            document.getElementById('perihal-body').innerText = data.x_06 || '-';
            document.getElementById('tanggal').innerText = data.x_07 || '';
            document.getElementById('penerima').innerText = data.x_03 || '-';
            document.getElementById('instansi').innerText = data.x_04 || '-';
            document.getElementById('nama-penanda').innerText = data.x_01 || '-';
            document.getElementById('jabatan-penanda').innerText = data.x_02 || '-';
            document.getElementById('keterangan').innerText = data.x_09 || 'Tidak ada catatan tambahan.';
            document.getElementById('token-footer').innerText = 'ID: ' + data.x_10;

            const verificationUrl = `https://lidan.co.id/sign/surat_penawaran?token=${data.x_10}`;
            
            new QRCode(document.getElementById("qrcode"), {
                text: verificationUrl,
                width: 120,
                height: 120,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : 3
            });
        }

        function downloadPDF() {
            const element = document.getElementById('invoice-content');
            const nomorSurat = document.getElementById('nomor').innerText.replace(/\//g, '_');
            
            const opt = {
                margin: 0,
                filename: `Surat_Penawaran_${nomorSurat}.pdf`,
                image: { type: 'jpeg', quality: 1 },
                html2canvas: { scale: 4, useCORS: true }, // Scale 4 agar sangat tajam
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save();
        }

        fetchSurat();
    </script>
</body>
</html>